{% extends 'base.html' %}
{% block content %}


<!-- <h5>This is the homepage - testing routes</h5> -->


 <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 80%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <button type="button" class="btn btn-info btn-sm" id="mysaved">Click to show saved records</button>
    <div id="map"></div>
    <button type="button" id="myloc">Click to show weather</button>
    <div class="card-group" id="weather">Put weather info here</div>


<!-- <div class="card-group">
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Card title</h5>
      <p class="card-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
    </div>
    <div class="card-footer">
      <small class="text-muted">Last updated 3 mins ago</small>
    </div>
  </div>
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Card title</h5>
      <p class="card-text">This card has supporting text below as a natural lead-in to additional content.</p>
      <p class="card-text">test this</p>
    </div>
    <div class="card-footer">
      <small class="text-muted">Last updated 3 mins ago</small>
    </div>
  </div>
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Card title</h5>
      <p class="card-text">This is a wider card with supporting text below as a natural lead-in to additional content. This card has even longer content than the first to show that equal height action.<i class="fas fa-cloud"></i></p>
    </div>
    <div class="card-footer">
      <small class="text-muted">Last updated 3 mins ago</small>
    </div>
  </div>
</div> -->


    <script>
      let ds_key = {{ds_key|tojson}}
      let gmap_key = {{gmap_key|tojson}}

      var map;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 37.368, lng: -122.036346},
          zoom: 3,
          styles: [
            {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
            {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
            {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
            {
              featureType: 'administrative.locality',
              elementType: 'labels.text.fill',
              stylers: [{color: '#d59563'}]
            },
            {
              featureType: 'poi',
              elementType: 'labels.text.fill',
              stylers: [{color: '#d59563'}]
            },
            {
              featureType: 'poi.park',
              elementType: 'geometry',
              stylers: [{color: '#263c3f'}]
            },
            {
              featureType: 'poi.park',
              elementType: 'labels.text.fill',
              stylers: [{color: '#6b9a76'}]
            },
            {
              featureType: 'road',
              elementType: 'geometry',
              stylers: [{color: '#38414e'}]
            },
            {
              featureType: 'road',
              elementType: 'geometry.stroke',
              stylers: [{color: '#212a37'}]
            },
            {
              featureType: 'road',
              elementType: 'labels.text.fill',
              stylers: [{color: '#9ca5b3'}]
            },
            {
              featureType: 'road.highway',
              elementType: 'geometry',
              stylers: [{color: '#746855'}]
            },
            {
              featureType: 'road.highway',
              elementType: 'geometry.stroke',
              stylers: [{color: '#1f2835'}]
            },
            {
              featureType: 'road.highway',
              elementType: 'labels.text.fill',
              stylers: [{color: '#f3d19c'}]
            },
            {
              featureType: 'transit',
              elementType: 'geometry',
              stylers: [{color: '#2f3948'}]
            },
            {
              featureType: 'transit.station',
              elementType: 'labels.text.fill',
              stylers: [{color: '#d59563'}]
            },
            {
              featureType: 'water',
              elementType: 'geometry',
              stylers: [{color: '#17263c'}]
            },
            {
              featureType: 'water',
              elementType: 'labels.text.fill',
              stylers: [{color: '#515c6d'}]
            },
            {
              featureType: 'water',
              elementType: 'labels.text.stroke',
              stylers: [{color: '#17263c'}]
            }]

        });
      // var marker = new google.maps.Marker({position: {lat: 37.368, lng: -122.036346}, map: map});

      // Testing kml overlay with an example template

      // var ctaLayer = new google.maps.KmlLayer({
      //   url: 'http://googlemaps.github.io/js-v2-samples/ggeoxml/cta.kml',
      //   map: map
      //   });

      // ctaLayer.setMap(map);


      let d_infow = new google.maps.InfoWindow();

      // Loading geojson format files from route and showing on map

      $.getJSON('/locations.json', function(data) {
        map.data.addGeoJson(data);
        map.data.setStyle({
          icon: "http://maps.google.com/mapfiles/ms/micons/blue.png"
        });

      });
      // map.data.loadGeoJson('/locations.json');
      // map.data.setStyle({
      //     icon: "http://maps.google.com/mapfiles/ms/micons/blue.png"
      //   });
      // Add event listener that shows info window (latlng info) on click
      map.data.addListener('click', function(e) {
        console.log(e.latLng.toString());
        console.log(e);
        d_infow.setContent(`${e.latLng.toString()}`);
        d_infow.setPosition(e.latLng);
        d_infow.open(map);

        let url = `https://api.darksky.net/forecast/${ds_key}/${e.latLng.lat()},${e.latLng.lng()}?callback=?`
        console.log(url)
        $.getJSON(url, function(json) {
          console.log(json);
          console.log(json['daily']['data'][0]['summary']);
          let date = moment(parseInt(json['currently']['time'])*1000);  //using moment library to make object
          console.log(date.format('MMMM Do YYYY, h:mm:ss a'));
          console.log(date.format('MMMM Do YYYY'));
          var x;
          // let txt = `Current time: ${date.format('MMMM Do YYYY, h:mm:ss a')}<br><br><div id="container">`;
          var head = `<table class="table table-hover"><thead><tr><th scope="col">Day</th><th scope="col">Summary</th> <th scope="col">Clouds</th><th scope="col">Moonphase</th><th scope="col">Save</th></tr></thead><tbody>`;
          let body = ``
          // $('#weather').html(`<h5>Time: ${date}</h5><h5>Weather: ${json['currently']['summary']}</h5>`)
          for (x in json['daily']['data']) {

            let timestamp = json['daily']['data'][x]['time']
            // txt += `<div class="pane"><li>DateTime: ${moment(parseInt(timestamp)*1000).tz(json['timezone']).format('MMMM Do YYYY, dddd')} (${json['timezone']})</li>
            //        <li>Summary: ${json['daily']['data'][x]['summary']}</li>
            //        <li>Cloud cover: ${json['daily']['data'][x]['cloudCover']}</li>
            //        <li>Moon phase: ${json['daily']['data'][x]['moonPhase']}</li>
            //        <button type="button" class="savetime" data-time="${timestamp}">Save</button><br><br></div>`;

            body += `<tr><th scope="row">${moment(parseInt(timestamp)*1000).tz(json['timezone']).format('ddd, MMMM Do')}</th><td>${json['daily']['data'][x]['summary']}</td><td>${json['daily']['data'][x]['cloudCover']}</td><td>${json['daily']['data'][x]['moonPhase']}</td><td><button type="button" class="savetime" data-time="${timestamp}">Save</button></td></tr>`

          }
          // txt = txt+"</div>"
          head = head+body+"</tbody></table>"
          // document.getElementById("weather").innerHTML = txt;
          d_infow.setContent(`${e.feature.f['name']} ${e.latLng.toString()}<br>Light value: ${e.feature.f['light']}<br><br>${head}`);

          // Setup event listener to post timestamp info stored in button and latlng info from event

          $('.savetime').click(function() {
            console.log($(this).attr('data-time'));
            console.log(e.latLng.lat());
            let info = {'lat': e.latLng.lat(), 'lng': e.latLng.lng(), 'timestamp': $(this).attr('data-time')}
            $.post("/save-json", info, function(data) { console.log(data); })

          });


          // $('button').click(function(){
          //   console.log($(this).attr('data-time'))
          //   console.log(e.latLng.lat())

          //   let info = {'lat': e.latLng.lat(), 'lng': e.latLng.lng(), 'timestamp': $(this).attr('data-time')}
          //   $.post("/save-json", info, function(data) { console.log(data); })
          // });

        });
      });

      // Place marker on click

      map.addListener('click', function(e) {
      placeMarker(e.latLng, map);
      });

      // Try to load user saved data

      let s_infow = new google.maps.InfoWindow();

      let saved_b = document.querySelector('#mysaved');
      saved_b.addEventListener('click', function() {
          // map.data.setMap(null);
          $.getJSON('/myrecords.json', function(data) {console.log(data);});
          data1 = new google.maps.Data();
          data1.loadGeoJson('/myrecords.json');
          data1.setMap(map);
          data1.setStyle({icon: "http://maps.google.com/mapfiles/ms/micons/yellow.png"});
          console.log("loaded my saved");

          data1.addListener("mouseover", function(evt) {

            let url1 = `https://api.darksky.net/forecast/${ds_key}/${evt.latLng.lat()},${evt.latLng.lng()},${evt.feature.f["timestamp"]}?callback=?`

            $.getJSON(url1, function(json) { 
                  // TEST THIS
                infotxt = `<strong>${evt.feature.f["name"]}</strong><br>
                Saved date: ${moment(parseInt(evt.feature.f["timestamp"])*1000).tz(json['timezone']).format('MMMM Do YYYY, dddd')} (${json['timezone']})<br>
                Cloud cover: ${json['daily']['data'][0]['cloudCover']}<br>
                MoonPhase: ${json['daily']['data'][0]['moonPhase']}<br><br>
                <form>Rate this location: 
                      <input type="radio" name="rating" value="1"> 1 
                      <input type="radio" name="rating" value="2"> 2 
                      <input type="radio" name="rating" value="3"> 3 
                      <input type="radio" name="rating" value="4"> 4 
                      <input type="radio" name="rating" value="5"> 5 </form>`

                s_infow.setPosition(evt.latLng);
                s_infow.setContent(infotxt)
                s_infow.open(map);
                console.log(evt.feature.f["timestamp"]);
                console.log(evt.feature.f["loc_id"])

                $('[type*="radio"]').change(function() {

                  formInput = {"score": $(this).attr('value'), "saved_id": evt.feature.f["saved_id"]}

                  console.log($(this).attr('value'))
                  $.post('/rating-json', formInput, function(data){
                    alert(data);

                  });
                });

            });

            // infotxt = `<strong>${evt.feature.f["name"]}</strong><br>
            // saved time: ${moment(parseInt(evt.feature.f["timestamp"])*1000).format('MMMM Do YYYY, dddd')}`

            // s_infow.setPosition(evt.latLng);
            // s_infow.setContent(infotxt)
            // s_infow.open(map);
            // console.log(evt.feature.f["timestamp"])

          });


          // data1.setMap(null);
          // console.log("removed my saved");

          // $.getJSON('/myrecords.json', function(data) {
          //     console.log("Test this")
          //     map.data.addGeoJson(data);
          //     map.data.setStyle({
          //       icon: "http://maps.google.com/mapfiles/ms/micons/yellow.png"
          //     });
          //   });

              // map.data.loadGeoJson('/myrecords.json');
              // map.data.setStyle({
              // icon: "http://maps.google.com/mapfiles/ms/micons/yellow.png"
              // });
      });



      // Generate info window that shows current location

      infoWindow = new google.maps.InfoWindow;

      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            infoWindow.setPosition(pos);
            infoWindow.setContent('Location found.');
            infoWindow.open(map);
            map.setCenter(pos);

            // Pass current position info to button 
            let button = document.querySelector('#myloc');
            button.addEventListener('click', function(e) {
              console.log('Button clicked and listened for event');
              console.log(pos);
              console.log(pos.lat);
              console.log(pos.lng);
              let url = `https://api.darksky.net/forecast/182208326a8cfd708f594c9b45e646b3/${pos.lat},${pos.lng}?callback=?`
              console.log(url)
              $.getJSON(url, function(json) {
                console.log(json);
                console.log(json['daily']['data'][0]['summary']);
                let date = new Date(parseInt(json['currently']['time'])*1000)
                var x;
                // let txt = `Current time: ${date}<br><br><div id="container">`;
                let txt2 = ``

                // $('#weather').html(`<h5>Time: ${date}</h5><h5>Weather: ${json['currently']['summary']}</h5>`)
                for (x in json['daily']['data']) {
                  // let dt = new Date(parseInt(json['daily']['data'][x]['time']))
                  // txt += `<div class="pane"><li>DateTime: ${new Date(parseInt(json['daily']['data'][x]['time'])*1000)}</li>
                  //        <li>Summary: ${json['daily']['data'][x]['summary']}</li>
                  //        <li>Cloud cover: ${json['daily']['data'][x]['cloudCover']}</li>
                  //        <button class="save">Save</button><br><br></div>`;

                  txt2 += `<div class="card">
                          <div class="card-body">
                            <h6 class="card-title">${moment(parseInt(json['daily']['data'][x]['time'])*1000).format('dddd')}</h6>
                            <p class="card-text">${json['daily']['data'][x]['summary']}</p>
                            <img src="/static/Cloud-Drizzle.svg" />
                          </div>
                          <div class="card-footer">
                            <small class="text-muted"><i class="fas fa-cloud"></i> ${json['daily']['data'][x]['cloudCover']}%<br><i class="fas fa-moon"></i> ${json['daily']['data'][x]['moonPhase']}</small>
                          </div>
                        </div>`;
                }

                document.getElementById("weather").innerHTML = txt2;

                // container.onclick = function(e){
                //   if (e.target.className != 'save') return;

                //   let pane = e.target.closest('.pane');
                //   console.log(pane);
                //   console.log(pane.getElementsByTagName("li")[0].innerHTML)
                // }

              });

            });

          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      } // last curly bracket for init map function

      

    // This function places new marker on map and posts latlng coordinates to server
    function placeMarker(position, map) {
      var marker = new google.maps.Marker({
          position: position,
          map: map
      });
      map.panTo(position);
      marker.addListener('click', function(e) {
        var light_val;

        $.post('/lightinfo', {"lat": e.latLng.lat(), "lng": e.latLng.lng()}, function(data) {
            console.log(data)
            light_val = data

            var new_infow = new google.maps.InfoWindow();
            var text = `<div id="form"><table>
          <tr><td>Name:</td> <td><input type='text' id='name'/> </td> </tr>
          <tr><td>Description:</td> <td><input type='text' id='describe'/> </td> </tr>
          <tr><td></td><td><input type='button' value='Save' id='newloc'/></td></tr>
          </table></div>`

            new_infow.setContent(`${e.latLng.toString()}<br>${data}<br>${text}`);
            new_infow.setPosition(e.latLng);
            new_infow.open(map);
            console.log(e)

            $("#newloc").on("click", function(evt) {

                let formInputs = {"lat": e.latLng.lat(),
                                  "lng": e.latLng.lng(),
                                  "name": $("#name").val(),
                                  "desc": $("#describe").val()}
                $.post("/markercoord", formInputs, function(d) { 
                  alert(d); 
                  new_infow.close();
                  marker.setMap(null) 
                  map.data.loadGeoJson('/locations.json');
                });

          });


        });





        
        // var coord = e.latLng.toJSON()
        // console.log(coord)        
        // $.post( "/markercoord", e.latLng.toJSON());
        // $.post( "/markercoord", {coord_data: coordstr})
      });
      // let coordlat = marker.getPosition().lat();
      // let coordlng = marker.getPosition().lng();
      // coord = `${coordlat},${coordlng}`
      // console.log([coordlat, coordlng])
      // $.post( "/markercoord", {coord_data: coord});
    }



      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);  
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{gmap_key}}&callback=initMap"
    async defer></script>
  </body>








{% endblock %}